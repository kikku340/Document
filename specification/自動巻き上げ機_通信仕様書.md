# 自動巻き上げ機  通信仕様書

## 変更履歴
| ver | 変更日時 | 変更者 | 変更内容 |
|:----|:--------:|:------:|---------:|
| 0.1 | 2021/02/31 | gari | 新規作成 |


## 目次
- [用語](#用語)
- [基本仕様](#基本仕様)
- [IPアドレス割当](#IPアドレス割当)
- [電文フォーマット](#電文フォーマット)
- [コマンド一覧](#コマンド一覧)
  - [通信開始コマンド](#通信開始コマンド)
  - [状態通知コマンド](#状態通知コマンド)
  - [動作制御コマンド](#動作制御コマンド)
- [コマンドのリトライについて](#コマンドのリトライについて)


## 用語

- サーバ : 自動巻き上げ機の制御を管理するPC
- クライアント : 実際にアクチュエータを制御する機器


## 基本仕様

本仕様書では、クライアントとサーバ間の通信仕様を記載する。

![overview](image/OverallView.png)  

- サーバ・クライアント間の通信はTCP/IPで通信を行う。  
- IPアドレスはIPv4を使用し、各機器は全て固定アドレスを持つ。
- 通信は全て1対1で通信を行い、ブロードキャストは使用しない。  
- 初回通信や定期通信はクライアントから送信する。
- 電文フォーマットの変更に対応するため、最後に通信した際の電文フォーマットバージョンを保存する。
- 電文が化けた場合やチェックサムが異なる場合は、受信した電文を破棄する。
- 各通信の応答は30s以内に行う。時間内の応答が不可能な場合はNAKを応答する。


## IPアドレス割当

以下にそれぞれの機器のIPアドレス割当を記載する。

| 機器 | 第1-2オクテット | 第3オクテット | 第4オクテット |
|-----:|:---------------:|:-------------:|:--------------|
| サーバ | 192.168 | 0 | 1 |
| クライアント | 192.168 | ハウスNo(1～) | ハウス内ID(1～) |

クライアント機は、ハウス毎に第3オクテットを分け、
ハウス内の機器毎に順番に割り当てを行う。


## 電文フォーマット

サーバ・クライアント間の通信電文は以下のフォーマットで構成される。<br>
![command_format](image/command_format.png)

| 項目 | Size(Byte) | 説明 |
|-----:|:------------:|:-----|
| `STX` | 1 | 制御コード(0x02) |
| `送信元ID` | 2 | 送信元のIPアドレス(第3、第4オクテット) |
| `送信先ID` | 2 | 送信先のIPアドレス(第3、第4オクテット) |
| `電文番号` | 2 | 電文毎に加算していき、0xFFFF→0x0000となる<br>ResponseはRequestと同じ電文番号で行う |
| `コマンド` | 1 | コマンドID |
| `データサイズ` | 1 | データ部のサイズ |
| `データ部` | 可変長 | コマンドに応じたデータ |
| `ETX` | 1 | 制御コード(0x03) |
| `チェックサム` | 1 | CRC16-CCITT(STXからETXまで) |


## コマンド一覧

以下にサーバ・クライアント間で使用可能なコマンドを記載する。

| コマンド | コマンド名 | 説明 |
|---------:|:----------:|:-----|
| `0x01` | 通信開始コマンド | サーバとの接続確認を行う |
| `0x10` | 状態通知コマンド | サーバへクライアントの状態通知を行う |
| `0x11` | 動作制御コマンド | サーバからクライアントへの制御要求を行う |


### 通信開始コマンド

クライアントの起動時にサーバとの通信確認のために行う。<br>
コマンドID:0x01

■クライアント→サーバへの電文(Request)<br>
![command_wakeup_req](image/command_wakeup_req.png)

| コマンド名 | Size(Byte) | 説明 |
|-----------:|:----------:|:-----|
| `ハウスNo` | 1 | ハウス毎に割り当てられる番号 |
| `ハウス内ID` | 1 | ハウス内の機器にそれぞれ割り当てるID |
| `クライアント種別ID` | 1 | [クライアントIDリスト](#クライアントIDリスト)を参照 |

■サーバ→クライアントへの電文(Response)<br>
![command_wakeup_res](image/command_wakeup_res.png)

| コマンド名 | Size(Byte) | 説明 |
|-----------:|:----------:|:-----|
| `処理結果` | 1 | ACK:電文を正常に処理できた場合に応答する<br>NAK:電文の処理が失敗した場合に応答する |
| `電文フォーマットバージョン` | 1 | 電文のバージョン番号 |

#### クライアントIDリスト
| クライアントIDリスト | クライアント種別名 |
|---------------------:|:-------------------|
| 0x01 | 自動巻き上げ機 |


### 状態通知コマンド

クライアントの状態通知と死活監視のために行う。<br>
コマンドID:0x10

■クライアント→サーバへの電文(Request)<br>
![command_status](image/command_status_req.png)

| コマンド名 | Size(Byte) | 説明 |
|-----------:|:----------:|:-----|
| `モータ動作状態` | 1 | 0x00:空転<br>0xA0:正転<br>0x0A:逆転<br>0xFF:ブレーキ |
| `上下限スイッチ状態` | 1 | 0x00:上下スイッチOFF<br>0x0A:上スイッチON<br>0xA0:下スイッチON |
| `開き具合段階` | 1 | 開き具合の段階情報(TDB) |
| `異常状態` | 2 | [異常状態一覧](#異常状態一覧)を参照 |

■サーバ→クライアントへの電文(Response)  

| コマンド名 | Size(Byte) | 説明 |
|-----------:|:----------:|:-----|
| `処理結果` | 1 | ACK:電文を正常に処理できた場合に応答する<br>NAK:電文の処理が失敗した場合に応答する |

#### 異常状態一覧
| 異常ID | 説明 |
|-------:|:-----|
| 0x0000 | 異常なし |
| 0x0001 | 温度異常 |
| 0x0002 | リミットスイッチ異常 |
| 0x0004 | 距離センサ異常 |
| 0x0008 | 電流異常 |
| 0x0010～0x8000 | 予備 |


### 動作制御コマンド

サーバからクライアントへの動作要求を行う。<br>
コマンドID:0x11

■サーバ→クライアントへの電文(Request)<br>
![command_action](image/command_action_req.png)

| コマンド名 | Size(Byte) | 説明 |
|-----------:|:----------:|:-----|
| `モータ動作要求` | 1 | 0x0F:全開<br>0xFF:全閉 |
| `動作制御` | 1 | 予備 |

■サーバ→クライアントへの電文(Response)  

| コマンド名 | Size(Byte) | 説明 |
|-----------:|:----------:|:-----|
| `処理結果` | 1 | ACK:電文を正常に処理できた場合に応答する<br>NAK:電文の処理が失敗した場合に応答する |


## コマンドのリトライについて

コマンドの応答がNAKの場合や、応答が無かった場合の動作を記載する。<br>
リトライが発生した場合は10s～30s間ランダムで待機後、失敗した通信を再送信する。<br>


